{% extends "base.html" %}

{% block title %}Admin Panel{% endblock %}

{% block content %}
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Admin Panel</h1>

                <!-- Link to Audit Logs (Super Admin Only) -->
                {% if current_user.is_super_admin %}
                    <a href="{{ url_for('admin_logs') }}" class="bg-gray-800 dark:bg-gray-700 text-white px-3 py-1 rounded-md text-xs font-bold hover:bg-black dark:hover:bg-gray-600 transition shadow-sm no-underline flex items-center gap-1">
                        <span>üìú</span> View Logs
                    </a>
                {% endif %}
            </div>

            <a href="{{ url_for('calendar_view') }}" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium">‚Üê Back to My Calendar</a>
        </div>

        <!-- FLASH MESSAGES (Auto-dismiss) -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div id="flash-messages" class="mb-6 space-y-2 transition-opacity duration-1000">
                {% for category, message in messages %}
                    <div class="{{ 'text-green-600 bg-green-100 dark:bg-green-900 dark:text-green-200 border-green-600' if category == 'success' else 'text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-200 border-red-600' }} p-3 rounded-lg border-l-4">
                        {{ message }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl overflow-hidden border border-gray-200 dark:border-gray-700 transition-colors duration-300">
            <!-- Search Bar Section -->
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex justify-between items-center flex-wrap gap-4">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">User Management</h2>

                <form method="GET" action="{{ url_for('admin_dashboard') }}" class="flex gap-2 w-full sm:w-auto">
                    <input type="text" name="q" value="{{ search_query }}" placeholder="Search by username..."
                           class="border border-gray-300 dark:border-gray-600 rounded-md px-3 py-1.5 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-64 placeholder-gray-400 dark:placeholder-gray-500">
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-1.5 rounded-md text-sm hover:bg-indigo-700 dark:hover:bg-indigo-500 transition">Search</button>
                    {% if search_query %}
                        <a href="{{ url_for('admin_dashboard') }}" class="bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 px-3 py-1.5 rounded-md text-sm hover:bg-gray-300 dark:hover:bg-gray-500 transition flex items-center">Clear</a>
                    {% endif %}
                </form>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">User Info</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Role & Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Admin Notes (Hidden)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {% if users %}
                            {% for user in users %}
                            <!-- FIX: Replaced invalid 'dark:hover:bg-gray-750' with 'dark:hover:bg-gray-700' -->
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <!-- User Info + Avatar -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <!-- AVATAR LOGIC -->
                                            {% if user.profile_pic and user.profile_pic != 'default.jpg' %}
                                                <img class="h-10 w-10 rounded-full object-cover border border-gray-200 dark:border-gray-600" src="{{ url_for('static', filename='uploads/profile_pics/' + user.profile_pic) }}" alt="">
                                            {% else %}
                                                <!-- Fallback: Initials -->
                                                <div class="h-10 w-10 rounded-full bg-[#FFA07A] flex items-center justify-center text-white font-bold text-lg border border-gray-200 dark:border-gray-600">
                                                    {{ user.username[0].upper() }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="ml-4">
                                            <!-- Link to Profile -->
                                            <a href="{{ url_for('profile', user_id=user.id) }}" class="text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 hover:underline">
                                                {{ user.username }}
                                            </a>
                                            <div class="text-sm text-gray-500 dark:text-gray-400">{{ user.email }}</div>
                                        </div>
                                    </div>
                                </td>

                                <!-- Role and Toggle Button -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex flex-col gap-2">
                                        {% if user.is_super_admin %}
                                            <span class="px-2 inline-flex text-xs leading-5 font-bold rounded-full bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 w-fit border border-yellow-300 dark:border-yellow-700">
                                                üëë Super Admin
                                            </span>
                                        {% elif user.is_admin %}
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 w-fit">Admin</span>
                                            <!-- Only Super Admin can revoke Admin rights -->
                                            {% if current_user.is_super_admin and user.id != current_user.id %}
                                                <form action="{{ url_for('admin_toggle_status', user_id=user.id) }}" method="POST">
                                                    <button type="submit" class="text-xs text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 border border-red-200 dark:border-red-800 px-2 py-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20">
                                                        Revoke Admin
                                                    </button>
                                                </form>
                                            {% endif %}
                                        {% else %}
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300 w-fit">User</span>
                                            <!-- Any admin can make someone an admin -->
                                            <form action="{{ url_for('admin_toggle_status', user_id=user.id) }}" method="POST">
                                                <button type="submit" class="text-xs text-green-600 dark:text-green-400 hover:text-green-900 dark:hover:text-green-300 border border-green-200 dark:border-green-800 px-2 py-1 rounded hover:bg-green-50 dark:hover:bg-green-900/20">
                                                    Make Admin
                                                </button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </td>

                                <!-- Admin Notes -->
                                <td class="px-6 py-4 align-top">
                                    <form action="{{ url_for('save_user_notes') }}" method="POST" class="flex flex-col gap-1 w-full">
                                        <input type="hidden" name="user_id" value="{{ user.id }}">

                                        <div class="flex gap-2 items-start">
                                            <textarea name="admin_notes" rows="2"
                                                      id="adminNote_{{ user.id }}"
                                                      maxlength="100"
                                                      class="text-sm border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 w-full resize-y bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                                      placeholder="Position, notes..."
                                                      oninput="validateAdminNote(this, '{{ user.id }}')">{{ user.admin_notes or '' }}</textarea>

                                            <!-- Button hidden by default -->
                                            <button type="submit" id="saveBtn_{{ user.id }}" style="display: none;" class="text-xs bg-indigo-50 dark:bg-indigo-900 hover:bg-indigo-100 dark:hover:bg-indigo-800 text-indigo-700 dark:text-indigo-200 px-3 py-1 rounded border border-indigo-200 dark:border-indigo-700 h-fit mt-1 transition">Save</button>
                                        </div>

                                        <!-- Validation Feedback -->
                                        <div class="flex justify-between px-1">
                                            <span id="noteError_{{ user.id }}" class="text-red-500 text-[10px] font-bold hidden">Invalid chars!</span>
                                            <span id="noteCount_{{ user.id }}" class="text-gray-400 dark:text-gray-500 text-[10px] ml-auto">0/100</span>
                                        </div>
                                    </form>
                                </td>

                                <!-- Actions (Manage Button) -->
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button onclick="openManageModal('{{ user.id }}', '{{ user.username }}', '{{ user.is_super_admin }}', '{{ user.is_admin }}')"
                                            class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 bg-indigo-50 dark:bg-indigo-900/30 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 px-3 py-2 rounded-md font-bold transition flex items-center gap-1">
                                        üß∞ Manage
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="px-6 py-10 text-center text-gray-500 dark:text-gray-400 italic">
                                    No users found matching "{{ search_query }}"
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MANAGE USER MODAL -->
    <div id="manageUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div class="relative mx-auto p-6 border w-96 shadow-xl rounded-xl bg-white dark:bg-gray-800 dark:border-gray-700 text-center">
            <button onclick="document.getElementById('manageUserModal').style.display='none'" class="absolute right-4 top-4 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 text-2xl font-bold leading-none">&times;</button>

            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 border-b dark:border-gray-700 pb-4">Manage User: <span class="text-indigo-600 dark:text-indigo-400" id="manageUserName"></span></h3>

            <div class="flex flex-col gap-3">
                <!-- 1. View Calendar -->
                <a id="btnViewCalendar" href="#" class="w-full bg-indigo-600 dark:bg-indigo-500 text-white py-2 rounded-md hover:bg-indigo-700 font-bold no-underline">
                    üìÖ View Calendar
                </a>

                <!-- 2. View Profile -->
                <a id="btnViewProfile" href="#" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 font-bold no-underline">
                    üë§ View Profile
                </a>

                <!-- 3. Reset Password (Protected) -->
                <div id="divResetPass">
                    <form id="formResetPass" action="" method="POST" onsubmit="return confirm('Reset password to 1234?');">
                        <button type="submit" class="w-full bg-orange-500 text-white py-2 rounded-md hover:bg-orange-600 font-bold">
                            üîë Reset Password (1234)
                        </button>
                    </form>
                </div>

                <!-- 4. Delete User (Protected) -->
                <div id="divDeleteUser">
                    <form id="formDeleteUser" action="" method="POST" onsubmit="return confirm('WARNING: Delete this user? This action is irreversible.');">
                        <button type="submit" class="w-full bg-red-600 text-white py-2 rounded-md hover:bg-red-700 font-bold">
                            üóëÔ∏è Delete User
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-dismiss Flash Messages
        setTimeout(function() {
            const flashMessages = document.getElementById('flash-messages');
            if (flashMessages) {
                flashMessages.style.opacity = '0';
                setTimeout(() => flashMessages.remove(), 1000);
            }
        }, 3000);

        // --- ADMIN NOTE VALIDATION ---
        function validateAdminNote(input, userId) {
            const value = input.value;
            const countElem = document.getElementById('noteCount_' + userId);
            const errorElem = document.getElementById('noteError_' + userId);
            const saveBtn = document.getElementById('saveBtn_' + userId);

            // Update Count
            countElem.innerText = `${value.length}/100`;

            // Regex Check (Basic chars only)
            const regex = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9\s!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*$/;

            if (!regex.test(value)) {
                errorElem.classList.remove('hidden');
                input.classList.add('border-red-500', 'focus:ring-red-500');
                saveBtn.disabled = true;
                saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                saveBtn.style.display = 'block';
            } else {
                errorElem.classList.add('hidden');
                input.classList.remove('border-red-500', 'focus:ring-red-500');
                saveBtn.disabled = false;
                saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                saveBtn.style.display = 'block';
            }
        }

        // Init counts on load
        window.onload = function() {
            const textareas = document.querySelectorAll('textarea[name="admin_notes"]');
            textareas.forEach(ta => {
                const uid = ta.id.split('_')[1];
                const countElem = document.getElementById('noteCount_' + uid);
                if(countElem) countElem.innerText = `${ta.value.length}/100`;
            });
        };

        const CURRENT_USER_ID = {{ current_user.id }};
        const IS_CURRENT_SUPER = {{ 'true' if current_user.is_super_admin else 'false' }};

        function openManageModal(userId, userName, isSuper, isAdmin) {
            // Set basic info
            document.getElementById('manageUserName').innerText = userName;

            // Set dynamic links/actions
            document.getElementById('btnViewCalendar').href = "/admin/view/" + userId;
            document.getElementById('btnViewProfile').href = "/profile/" + userId;

            document.getElementById('formResetPass').action = "/admin/reset_password/" + userId;
            document.getElementById('formDeleteUser').action = "/admin/delete_user/" + userId;

            // Logic to hide/show buttons based on permissions
            const divReset = document.getElementById('divResetPass');
            const divDelete = document.getElementById('divDeleteUser');

            const targetIsSuper = (isSuper === 'True');
            const targetIsAdmin = (isAdmin === 'True');
            const isSelf = (userId == CURRENT_USER_ID);

            // Reset Password Logic
            if (IS_CURRENT_SUPER || (!targetIsAdmin && !targetIsSuper)) {
                divReset.style.display = 'block';
            } else {
                divReset.style.display = 'none';
            }

            // Delete User Logic
            let canDelete = true;
            if (targetIsSuper) canDelete = false;
            if (isSelf) canDelete = false;
            if (targetIsAdmin && !IS_CURRENT_SUPER) canDelete = false;

            if (canDelete) {
                divDelete.style.display = 'block';
            } else {
                divDelete.style.display = 'none';
            }

            // Show Modal
            document.getElementById('manageUserModal').style.display = 'flex';
        }
    </script>
{% endblock %}