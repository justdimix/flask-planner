{% extends "base.html" %}

{% block title %}Resources{% endblock %}

{% block content %}
    <!-- HEADER SECTION -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                Company Resources
            </h1>
            <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">
                Manage meeting rooms, equipment, and shared assets.
            </p>
        </div>

        <!-- ADD RESOURCE BUTTON -->
        {% if current_user.is_admin %}
        <button onclick="openAddResourceModal()" class="flex items-center gap-1 bg-indigo-600 dark:bg-indigo-500 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold shadow-md transition transform hover:scale-105 text-sm">
            <span class="text-lg leading-none">+</span> Add Resource
        </button>
        {% endif %}
    </div>

    <!-- FLASH MESSAGES -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages" class="mb-6 space-y-2 transition-opacity duration-1000">
            {% for category, message in messages %}
                <div class="{{ 'text-green-600 bg-green-100 dark:bg-green-900 dark:text-green-200 border-green-600' if category == 'success' else 'text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-200 border-red-600' }} p-3 rounded-lg border-l-4">
                    {{ message }}
                </div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- 1. ADD RESOURCE MODAL -->
    {% if current_user.is_admin %}
    <div id="addResourceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div class="relative mx-auto p-6 border w-full max-w-lg shadow-2xl rounded-xl bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700">

            <div class="flex justify-between items-center mb-6 border-b dark:border-gray-700 pb-2">
                <h2 class="text-xl font-bold text-indigo-600 dark:text-indigo-400">Add New Resource</h2>
                <button onclick="closeAddResourceModal()" class="text-gray-400 hover:text-red-500 text-3xl font-bold leading-none transition">&times;</button>
            </div>

            <form action="{{ url_for('add_resource') }}" method="POST" class="flex flex-col gap-4" id="addResourceForm">

                <!-- Resource Name -->
                <div>
                    <label class="block text-xs font-bold text-gray-700 dark:text-gray-300 uppercase mb-1">Resource Name</label>
                    <input type="text" name="name" required maxlength="50"
                           class="w-full border border-gray-300 dark:border-gray-600 rounded p-2 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500"
                           placeholder="e.g. Meeting Room A, Projector 1...">
                </div>

                <!-- Resource Description -->
                <div>
                    <label class="block text-xs font-bold text-gray-700 dark:text-gray-300 uppercase mb-1">Description</label>
                    <textarea name="description" maxlength="200" rows="3"
                           class="w-full border border-gray-300 dark:border-gray-600 rounded p-2 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500"
                           placeholder="Optional details..."></textarea>
                </div>

                <!-- VISIBILITY: REMOVED USER SELECTION FOR CREATION -->
                <!-- Default is now always 'all' (Visible to Everyone) -->
                <input type="hidden" name="visible_user_ids" value="all">

                <!-- Create Button -->
                <div class="w-full flex justify-end mt-4 pt-4 border-t dark:border-gray-700">
                    <button type="submit" class="bg-indigo-600 dark:bg-indigo-500 text-white py-2 px-6 rounded hover:bg-indigo-700 font-bold transition transform hover:scale-105 shadow-md">
                        Create Resource
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. EDIT RESOURCE MODAL -->
    <div id="editResourceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div class="relative mx-auto p-6 border w-full max-w-lg shadow-2xl rounded-xl bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700">

            <div class="flex justify-between items-center mb-6 border-b dark:border-gray-700 pb-2">
                <h2 class="text-xl font-bold text-indigo-600 dark:text-indigo-400">Edit Resource</h2>
                <button onclick="closeEditResourceModal()" class="text-gray-400 hover:text-red-500 text-3xl font-bold leading-none transition">&times;</button>
            </div>

            <form id="editResourceForm" method="POST" class="flex flex-col gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-700 dark:text-gray-300 uppercase mb-1">Resource Name</label>
                    <input type="text" name="name" id="editName" required maxlength="50"
                           class="w-full border border-gray-300 dark:border-gray-600 rounded p-2 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-700 dark:text-gray-300 uppercase mb-1">Description</label>
                    <textarea name="description" id="editDesc" maxlength="200" rows="3"
                           class="w-full border border-gray-300 dark:border-gray-600 rounded p-2 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500"></textarea>
                </div>

                <!-- Visibility / User Selection (KEPT ONLY FOR EDITING) -->
                <div>
                    <label class="block text-xs font-bold text-gray-700 dark:text-gray-300 uppercase mb-1">Visibility</label>
                    <button type="button" onclick="openUserSelectionModal('edit')" class="w-full border border-gray-300 dark:border-gray-600 rounded p-2 text-sm bg-gray-50 dark:bg-gray-700 text-left text-indigo-600 dark:text-indigo-400 font-bold hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                        Manage Users...
                    </button>
                    <div id="editSelectedUsersCount" class="text-xs text-gray-500 dark:text-gray-400 mt-1"></div>
                    <input type="hidden" name="visible_user_ids" id="editVisibleUserIds" autocomplete="off">
                </div>

                <div class="w-full flex justify-between mt-4 pt-4 border-t dark:border-gray-700">
                    <button type="button" id="deleteResourceBtn" onclick="submitDeleteForm()" class="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 py-2 px-4 rounded hover:bg-red-200 dark:hover:bg-red-900/50 transition font-bold text-sm">
                        Delete Resource
                    </button>

                    <button type="submit" class="bg-indigo-600 dark:bg-indigo-500 text-white py-2 px-6 rounded hover:bg-indigo-700 font-bold transition transform hover:scale-105 shadow-md">
                        Save Changes
                    </button>
                </div>
            </form>

            <form id="hiddenDeleteForm" method="POST" style="display:none;"></form>
        </div>
    </div>

    <!-- 3. USER SELECTION MODAL -->
    <div id="userSelectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div class="relative mx-auto p-6 border w-80 shadow-2xl rounded-xl bg-white dark:bg-gray-800 dark:border-gray-700 flex flex-col max-h-[80vh]">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 text-center">Select Users</h3>

            <input type="text" placeholder="Search users..." class="w-full border border-gray-300 dark:border-gray-600 rounded mb-2 px-2 py-1 text-sm bg-white dark:bg-gray-700 dark:text-white" onkeyup="filterUsers(this)">

            <div class="overflow-y-auto flex-grow border border-gray-200 dark:border-gray-600 rounded p-2 mb-4 bg-white dark:bg-gray-700">
                <label class="flex items-center space-x-3 mb-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-2 rounded transition border-b dark:border-gray-600 pb-2">
                    <input type="checkbox" id="selectAllUsersCheckbox" class="rounded text-indigo-600 focus:ring-indigo-500 h-4 w-4" onchange="toggleSelectAllUsers(this)">
                    <span class="text-sm font-bold text-indigo-600 dark:text-indigo-400">Select All (Global)</span>
                </label>

                {% if all_users %}
                    {% for user in all_users %}
                        {% if not user.is_super_admin %}
                        <label class="flex items-center space-x-3 mb-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-2 rounded transition user-select-item">
                            <input type="checkbox" name="user_checkbox" value="{{ user.id }}" class="rounded text-indigo-600 focus:ring-indigo-500 h-4 w-4 individual-user-checkbox">
                            <span class="text-sm text-gray-700 dark:text-gray-200 font-medium username-text">{{ user.username }}</span>
                        </label>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="text-xs text-gray-400 text-center">No users available.</p>
                {% endif %}
            </div>

            <div class="flex justify-center pt-2 border-t border-gray-100 dark:border-gray-600">
                <button type="button" onclick="saveUserSelection()" class="px-6 py-2 bg-indigo-600 dark:bg-indigo-500 text-white rounded-md hover:bg-indigo-700 font-bold text-sm shadow-md transition transform hover:scale-105">
                    Done
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- RESOURCES GRID -->
    {% if resources %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for res in resources %}
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 hover:shadow-xl transition-shadow duration-300 flex flex-col overflow-hidden relative group">
            {% if current_user.is_admin %}
            <button
                onclick="openEditResourceModal(this)"
                data-id="{{ res.id }}"
                data-name="{{ res.name }}"
                data-desc="{{ res.description }}"
                data-update-url="/update_resource/{{ res.id }}"
                data-delete-url="{{ url_for('delete_resource', id=res.id) }}"
                data-assigned-ids='{{ res.allowed_users|map(attribute="id")|list|tojson }}'
                class="absolute top-2 right-2 z-10 text-2xl hover:scale-125 transition transform cursor-pointer bg-white/80 dark:bg-gray-800/80 rounded-full w-8 h-8 flex items-center justify-center shadow-sm border border-gray-200 dark:border-gray-600"
                title="Edit Resource"
            >
                ðŸ¦”
            </button>
            {% endif %}

            <div class="bg-gray-50 dark:bg-gray-900 p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-start">
                <div class="pr-8">
                    <h3 class="font-bold text-lg text-gray-900 dark:text-white truncate" title="{{ res.name }}">
                        {{ res.name }}
                    </h3>
                    <span class="text-xs uppercase font-bold text-indigo-500 tracking-wide">Resource</span>
                </div>
            </div>

            <div class="p-4 flex-grow">
                <p class="text-gray-600 dark:text-gray-300 text-sm italic">
                    {% if res.description %}
                        {{ res.description }}
                    {% else %}
                        I took a walk to the fridge in honor of this resourse
                    {% endif %}
                </p>
            </div>

            <div class="p-4 bg-gray-50 dark:bg-gray-900/50 border-t border-gray-100 dark:border-gray-700 flex gap-2">
                <a href="{{ url_for('view_resource_calendar', id=res.id) }}" class="flex-1 bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 py-2 rounded-lg text-center text-sm font-bold hover:bg-indigo-200 dark:hover:bg-indigo-800 transition">
                    View Schedule ðŸ“…
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
        <div class="text-center py-20 bg-white dark:bg-gray-800 rounded-xl border border-dashed border-gray-300 dark:border-gray-700">
            <p class="text-gray-500 dark:text-gray-400 text-lg">No resources found.</p>
            {% if current_user.is_admin %}
            <p class="text-gray-400 dark:text-gray-500 text-sm mt-2">Click "Add Resource" to create one.</p>
            {% endif %}
        </div>
    {% endif %}

    <script>
        // --- RELIABLE GLOBAL CONSTANT ---
        const CURRENT_USER_ID = {{ current_user.id|default('null') }};

        // --- ADD RESOURCE MODAL ---
        function openAddResourceModal() {
            // Simplified: Just reset the form.
            // The hidden field 'visible_user_ids' is hardcoded to 'all' in HTML, so no JS logic needed.
            document.getElementById('addResourceForm').reset();
            document.getElementById('addResourceModal').style.display = 'flex';
        }

        function closeAddResourceModal() {
            document.getElementById('addResourceModal').style.display = 'none';
        }

        // --- EDIT RESOURCE MODAL ---
        function openEditResourceModal(btn) {
            const id = btn.getAttribute('data-id');
            const name = btn.getAttribute('data-name');
            const desc = btn.getAttribute('data-desc');
            const updateUrl = btn.getAttribute('data-update-url');
            const deleteUrl = btn.getAttribute('data-delete-url');

            // Populate Fields
            document.getElementById('editName').value = name;
            document.getElementById('editDesc').value = desc === 'None' ? '' : desc;

            // Set Form Actions
            document.getElementById('editResourceForm').action = updateUrl;
            document.getElementById('hiddenDeleteForm').action = deleteUrl;

            // Handle Assigned Users
            const assignedIds = JSON.parse(btn.getAttribute('data-assigned-ids') || '[]');

            // Logic for Editing: If list is empty, force Private (Superadmin Only) to be safe for display
            if (assignedIds.length === 0) {
                 if (CURRENT_USER_ID) {
                     document.getElementById('editVisibleUserIds').value = JSON.stringify([CURRENT_USER_ID]);
                     document.getElementById('editSelectedUsersCount').innerText = "Visible to: Superadmin Only";
                 }
            } else {
                document.getElementById('editVisibleUserIds').value = JSON.stringify(assignedIds);
                document.getElementById('editSelectedUsersCount').innerText = `Visible to: ${assignedIds.length} users`;
            }

            document.getElementById('editResourceModal').style.display = 'flex';
        }

        function closeEditResourceModal() {
            document.getElementById('editResourceModal').style.display = 'none';
        }

        function submitDeleteForm() {
            if(confirm('Are you sure you want to delete this resource? All associated tasks will be removed.')) {
                document.getElementById('hiddenDeleteForm').submit();
            }
        }

        // --- USER SELECTION LOGIC ---
        let currentSelectionContext = null; // 'edit' only now basically

        function openUserSelectionModal(context) {
            currentSelectionContext = context;
            const modal = document.getElementById('userSelectionModal');
            const checkboxes = document.querySelectorAll('.individual-user-checkbox');
            const selectAll = document.getElementById('selectAllUsersCheckbox');

            // Reset checkboxes UI
            checkboxes.forEach(cb => cb.checked = false);
            selectAll.checked = false;

            // Load existing selection based on context
            let val = '[]';
            // We removed 'add' context logic from HTML, so this primarily handles 'edit'
            if (context === 'edit') {
                val = document.getElementById('editVisibleUserIds').value;
            }

            // Handle 'all' case or specific IDs
            if (val === 'all') {
                selectAll.checked = true;
                checkboxes.forEach(cb => cb.checked = true);
            } else if (val && val !== '') {
                try {
                    const currentIds = JSON.parse(val);
                    checkboxes.forEach(cb => {
                        if (currentIds.includes(parseInt(cb.value))) {
                            cb.checked = true;
                        }
                    });
                } catch(e) {
                    console.error("JSON Parse error", e);
                }
            }

            modal.style.display = 'flex';
        }

        function filterUsers(input) {
            const filter = input.value.toLowerCase();
            const items = document.querySelectorAll('.user-select-item');
            items.forEach(item => {
                const text = item.querySelector('.username-text').textContent.toLowerCase();
                item.style.display = text.includes(filter) ? 'flex' : 'none';
            });
        }

        function toggleSelectAllUsers(source) {
            const checkboxes = document.querySelectorAll('.individual-user-checkbox');
            checkboxes.forEach(cb => {
                if (source.checked) cb.checked = true;
                else cb.checked = false;
            });
        }

        function saveUserSelection() {
            const checkboxes = document.querySelectorAll('.individual-user-checkbox:checked');
            const allCheckboxes = document.querySelectorAll('.individual-user-checkbox');
            const selectAllCb = document.getElementById('selectAllUsersCheckbox');

            // Get IDs from checkboxes
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            let valueToStore;
            let labelText;

            // LOGIC FOR EDIT MODE (Keeping this robust as requested):
            // 1. If Select All checked OR all boxes checked -> 'all'
            // 2. If NO users checked -> Force Admin ID (Private)
            // 3. Otherwise -> Restricted list (as selected)

            if (selectAllCb.checked || (selectedIds.length === allCheckboxes.length && allCheckboxes.length > 0)) {
                valueToStore = 'all';
                labelText = "Visible to: Everyone (Global)";
            } else if (selectedIds.length === 0) {
                // FORCE ADMIN if empty to prevent accidental Global visibility
                if (CURRENT_USER_ID) {
                    valueToStore = JSON.stringify([CURRENT_USER_ID]);
                    labelText = "Visible to: Superadmin Only";
                } else {
                    valueToStore = '[]';
                    labelText = "Private";
                }
            } else {
                // Don't force admin here, just send selection.
                // Admin usually sees everything anyway via backend logic or being Superadmin.
                valueToStore = JSON.stringify(selectedIds);
                labelText = `Visible to: ${selectedIds.length} selected users`;
            }

            // We only need to update the Edit form now
            if (currentSelectionContext === 'edit') {
                document.getElementById('editVisibleUserIds').value = valueToStore;
                document.getElementById('editSelectedUsersCount').innerText = labelText;
            }

            document.getElementById('userSelectionModal').style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('addResourceModal')) closeAddResourceModal();
            if (event.target == document.getElementById('editResourceModal')) closeEditResourceModal();
        }

        setTimeout(function() {
            const flashMessages = document.getElementById('flash-messages');
            if (flashMessages) {
                flashMessages.style.opacity = '0';
                setTimeout(() => flashMessages.remove(), 1000);
            }
        }, 3000);
    </script>
{% endblock %}