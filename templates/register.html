{% extends "base.html" %}

{% block title %}Register{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 mt-10 transition-colors duration-300">
    <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-white mb-6">Create Account</h2>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-4">
                {% for category, message in messages %}
                    <div class="{{ 'text-green-600 bg-green-100 dark:bg-green-900 dark:text-green-200 border-green-200 dark:border-green-800' if category == 'success' else 'text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-200 border-red-200 dark:border-red-800' }} p-3 rounded-lg text-center text-sm font-bold border">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <form method="POST" id="registerForm">
        <!-- Username -->
        <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Username</label>
            <input type="text" name="username" id="regUsername" required
                   minlength="5" maxlength="15"
                   class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                   placeholder="5-15 chars, letters & numbers"
                   oninput="validateRegister()">
            <!-- Validation Feedback -->
            <p id="usernameError" class="text-xs text-red-500 dark:text-red-400 mt-1 font-bold hidden"></p>
            <p id="usernameCount" class="text-xs text-gray-400 dark:text-gray-500 mt-1 text-right">0/15</p>
        </div>

        <!-- Email -->
        <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Email</label>
            <input type="email" name="email" id="regEmail" required
                   minlength="8" maxlength="30"
                   class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                   placeholder="example@mail.com"
                   oninput="validateRegister()">
            <p id="emailError" class="text-xs text-red-500 dark:text-red-400 mt-1 font-bold hidden"></p>
            <p id="emailCount" class="text-xs text-gray-400 dark:text-gray-500 mt-1 text-right">0/30</p>
        </div>

        <!-- Password -->
        <div class="mb-6">
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Password</label>
            <input type="password" name="password" id="regPassword" required
                   minlength="4" maxlength="20"
                   class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                   placeholder="4-20 characters"
                   oninput="validateRegister()">
            <p id="passwordError" class="text-xs text-red-500 dark:text-red-400 mt-1 font-bold hidden"></p>
            <p id="passCount" class="text-xs text-gray-400 dark:text-gray-500 mt-1 text-right">0/20</p>
        </div>

        <button type="submit" id="regSubmitBtn" disabled class="w-full bg-indigo-600 dark:bg-indigo-500 text-white py-2 rounded-md hover:bg-indigo-700 dark:hover:bg-indigo-600 font-bold transition shadow-md opacity-50 cursor-not-allowed">
            Register
        </button>
    </form>

    <div class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400">
        Already have an account? <a href="{{ url_for('login') }}" class="text-indigo-600 dark:text-indigo-400 hover:underline font-bold">Login here</a>
    </div>
</div>

<script>
    function validateRegister() {
        const usernameInput = document.getElementById('regUsername');
        const emailInput = document.getElementById('regEmail');
        const passwordInput = document.getElementById('regPassword');
        const btn = document.getElementById('regSubmitBtn');

        const userErr = document.getElementById('usernameError');
        const emailErr = document.getElementById('emailError');
        const passErr = document.getElementById('passwordError');

        // Update counts
        document.getElementById('usernameCount').innerText = `${usernameInput.value.length}/15`;
        document.getElementById('emailCount').innerText = `${emailInput.value.length}/30`;
        document.getElementById('passCount').innerText = `${passwordInput.value.length}/20`;

        let isValid = true;

        // 1. Validate Username
        const username = usernameInput.value;
        const userRegex = /^[a-zA-Zа-яА-ЯёЁ0-9]+$/; // Only Letters (En/Ru) and Digits
        const lowerUser = username.toLowerCase();

        // Reset styles (handling dark mode classes too)
        userErr.classList.add('hidden');
        usernameInput.classList.remove('border-red-500', 'dark:border-red-500', 'bg-red-50', 'dark:bg-red-900/20');

        if (username.length > 0) {
            if (username.length < 5 || username.length > 15) {
                userErr.innerText = "Length must be between 5 and 15 characters.";
                userErr.classList.remove('hidden');
                usernameInput.classList.add('border-red-500', 'dark:border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                isValid = false;
            } else if (!userRegex.test(username)) {
                userErr.innerText = "Only letters (En/Ru) and numbers allowed. No spaces or symbols.";
                userErr.classList.remove('hidden');
                usernameInput.classList.add('border-red-500', 'dark:border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                isValid = false;
            } else if (lowerUser.includes('admin') || lowerUser.includes('super')) {
                userErr.innerText = "Username contains restricted words (Admin/Super).";
                userErr.classList.remove('hidden');
                usernameInput.classList.add('border-red-500', 'dark:border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                isValid = false;
            }
        } else {
            isValid = false; // Required
        }

        // 2. Validate Email
        const email = emailInput.value;
        emailErr.classList.add('hidden');
        emailInput.classList.remove('border-red-500', 'dark:border-red-500', 'bg-red-50', 'dark:bg-red-900/20');

        if (email.length > 0) {
            if (email.length < 8 || email.length > 30) {
                emailErr.innerText = "Length must be between 8 and 30 characters.";
                emailErr.classList.remove('hidden');
                emailInput.classList.add('border-red-500', 'dark:border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                isValid = false;
            }
        } else {
            isValid = false;
        }

        // 3. Validate Password
        const pass = passwordInput.value;
        passErr.classList.add('hidden');
        passwordInput.classList.remove('border-red-500', 'dark:border-red-500', 'bg-red-50', 'dark:bg-red-900/20');

        if (pass.length > 0) {
            if (pass.length < 4 || pass.length > 20) {
                passErr.innerText = "Length must be between 4 and 20 characters.";
                passErr.classList.remove('hidden');
                passwordInput.classList.add('border-red-500', 'dark:border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                isValid = false;
            }
        } else {
            isValid = false;
        }

        // Button State
        btn.disabled = !isValid;
        if (!isValid) {
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
</script>
{% endblock %}